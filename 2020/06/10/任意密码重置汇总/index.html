<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="逻辑漏洞,任意密码重置," />










<meta name="description" content="参考：乌云安全 注：逻辑类漏洞没有特定的姿势，可以参考，思路要拓宽，以下的姿势都已经被玩烂了。。。例如 token 的生成规律（在js文件中可能会找到或者是其他模糊测试） 任意用户密码重置可能出现在新用户注册页面，也可能出现在用户登陆后重置密码的页面，或者是用户忘记密码时密码找回页面（主要是密码找回功能页面）。 是否可以暴破验证码、是否可以劫持接收验证码的手机号或邮箱、是否可以混淆重置其他账号、是">
<meta property="og:type" content="article">
<meta property="og:title" content="任意密码重置汇总">
<meta property="og:url" content="http://yoursite.com/2020/06/10/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%B1%87%E6%80%BB/index.html">
<meta property="og:site_name" content="QuanYex&#39;s Blog">
<meta property="og:description" content="参考：乌云安全 注：逻辑类漏洞没有特定的姿势，可以参考，思路要拓宽，以下的姿势都已经被玩烂了。。。例如 token 的生成规律（在js文件中可能会找到或者是其他模糊测试） 任意用户密码重置可能出现在新用户注册页面，也可能出现在用户登陆后重置密码的页面，或者是用户忘记密码时密码找回页面（主要是密码找回功能页面）。 是否可以暴破验证码、是否可以劫持接收验证码的手机号或邮箱、是否可以混淆重置其他账号、是">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima9.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima10.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima11.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima12.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima13.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima14.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima15.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima16.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima1.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima2.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima3.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima4.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima5.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima6.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima7.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima8.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima17.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima18.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima19.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima20.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima21.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima22.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima23.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima24.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima25.png">
<meta property="og:image" content="http://lulu.izliang.com/yty/renyimima26.png">
<meta property="article:published_time" content="2020-06-10T12:32:35.000Z">
<meta property="article:modified_time" content="2020-06-10T15:57:25.969Z">
<meta property="article:author" content="QuanYex">
<meta property="article:tag" content="逻辑漏洞">
<meta property="article:tag" content="任意密码重置">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lulu.izliang.com/yty/renyimima9.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/10/任意密码重置汇总/"/>





  <title>任意密码重置汇总 | QuanYex's Blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">QuanYex's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/10/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%B1%87%E6%80%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="QuanYex">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1442298964,3218822834&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuanYex's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">任意密码重置汇总</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-10T20:32:35+08:00">
                2020-06-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-06-10T23:57:25+08:00">
                2020-06-10
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考：乌云安全</p>
<p>注：逻辑类漏洞没有特定的姿势，可以参考，思路要拓宽，以下的姿势都已经被玩烂了。。。例如 token 的生成规律（在js文件中可能会找到或者是其他模糊测试）</p>
<p>任意用户密码重置可能出现在新用户注册页面，也可能出现在用户登陆后重置密码的页面，或者是用户忘记密码时密码找回页面（主要是密码找回功能页面）。</p>
<p>是否可以暴破验证码、是否可以劫持接收验证码的手机号或邮箱、是否可以混淆重置其他账号、是否可以绕过验证步骤、猜测重置 token 的生成规律</p>
<h1 id="逻辑分析"><a href="#逻辑分析" class="headerlink" title="逻辑分析"></a>逻辑分析</h1><p>用户标识（用户名、用户ID、cookie）</p>
<p>接收端（手机、邮箱）</p>
<p>凭证（验证码、token）</p>
<p>若以上这几个要素没有完整关联，则可能导致任意密码重置漏洞</p>
<a id="more"></a>

<h1 id="重置姿势"><a href="#重置姿势" class="headerlink" title="重置姿势"></a>重置姿势</h1><h2 id="重置凭证接收端可篡改"><a href="#重置凭证接收端可篡改" class="headerlink" title="重置凭证接收端可篡改"></a>重置凭证接收端可篡改</h2><p><strong>① 接收端可篡改——请求包中包含接收端参数，可将凭证发送至指定接收端</strong></p>
<p>密码重置页面，输入任意普通账号，选择手机方式找回密码。在身份验证页面点击获取短信验证码，抓包。</p>
<p><img src="http://lulu.izliang.com/yty/renyimima9.png" alt=""></p>
<p>直接篡改为攻击者的手机号，成功接收短信验证码，提交验证码后，正常执行 3、4 步即可成功重置该账号的密码。</p>
<p><strong>②接收端可篡改。请求包中出现接收端间接相关参数，可将凭证发至指定接收端。</strong></p>
<p>在密码找回页面，用攻击账号 test0141，尝试重置目标账号 2803870097 的密码，在第一个首页中输入 test0141 和图片验证码完成“01 安全认证”，抓包</p>
<p><img src="http://lulu.izliang.com/yty/renyimima10.png" alt=""></p>
<p>输入图片验证码获取短信验证码完成 身份验证</p>
<p><img src="http://lulu.izliang.com/yty/renyimima11.png" alt=""></p>
<p>抓包：<img src="http://lulu.izliang.com/yty/renyimima12.png" alt=""></p>
<p>全流程下来，客户端并未直接提交接收短信验证码的手机号，多次尝试可知，02 中出现的 user_name 用于查询下发短信的手机号，用它可以间接指定接收端，那么，它是否仅此作用而不用于指定重置密码的账号？如下思路验证，先将 userName 置为 2803870097 完成 01 以告诉服务端重置的账号，再将 user_name 置为 test0141 完成 02 以欺骗服务端将短信验证码发至攻击者手机，顺序完成 03、04 或许能实现重置 2803870097 的密码。</p>
<p><img src="http://lulu.izliang.com/yty/renyimima13.png" alt=""></p>
<p><img src="http://lulu.izliang.com/yty/renyimima14.png" alt=""></p>
<p><img src="http://lulu.izliang.com/yty/renyimima15.png" alt=""></p>
<p>将 user_name 从 2803870097 篡改为 test0141，控制服务端将验证码发至 test0141 绑定的手机号</p>
<p><img src="http://lulu.izliang.com/yty/renyimima16.png" alt=""></p>
<p>test0141 的手机号成功接收到验证码 ，将该验证码填入重置 2803870097 的身份校验页面后提交，输入新密码 PenTest1024 后提交，系统提示重置成功，用 2803870097/PenTest1024 登录，验证成功。</p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>一定要将重置用户与接收重置凭证的手机号/邮箱作一致性比较，通常直接从服务端直接生成手机号/邮箱，不从客户端获取。</p>
<h2 id="重置凭证发送端可获取"><a href="#重置凭证发送端可获取" class="headerlink" title="重置凭证发送端可获取"></a>重置凭证发送端可获取</h2><p><strong>①作为重置凭证的验证码在HTTP应答中下发客户端，抓包后可获取</strong></p>
<p>测试： 先用攻击者账号走一次密码找回流程，测试账号<a href="mailto:xxx@qq.com">xxx@qq.com</a> 选用邮箱找回密码，点击获取校验码后抓包</p>
<p><img src="http://lulu.izliang.com/yty/renyimima1.png" alt=""></p>
<p>VFcode通过其字面含义很有可能时验证码。登录邮箱查看发过来的验证码为934456，发现匹配。此时可以确认服务端密码找回的验证码泄露至客户端。</p>
<p>尝试找回普通账号的密码。密码找回首页输入邮箱后，系统将立即校验该邮箱是否注册：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima2.png" alt=""></p>
<p>将 UName 参数定义为枚举变量，以常见 qq 邮箱作为字典，可枚举出多个有效邮箱：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima3.png" alt=""></p>
<p>以 <a href="mailto:chenwei@qq.com">chenwei@qq.com</a> 为例，在应答包中找到校验码，成功将其密码重置为 PenTest1024，验证可登录。尝试找回管理员账号的密码。从该网站的域名注册信息中找到联系人的邮箱为 <a href="mailto:fishliu@xxxx.cn">fishliu@xxxx.cn</a>，可推测后台用户的邮箱后缀为 @xxxx.cn，所以，用常见后台用户名简单调整可构造出后台用户邮箱字典，枚举出大量后台用户：</p>
<p><strong>②用邮件找回密码时，带凭证的重置链接泄漏至客户端，抓捕可获取。</strong></p>
<p>用攻击者账号走一次密码找回流程。在找回密码页面输入攻击者账号及其邮箱（xxxxx、<a href="mailto:xxxx@yeah.net">xxxx@yeah.net</a>）后提交：抓包</p>
<p><img src="http://lulu.izliang.com/yty/renyimima4.png" alt=""></p>
<p>显然是个重定向，isVerify、PassPhrase 这两个参数很可疑，后续交互中应留意，先放包，进入发送重置邮件的页面，输入验证码后提交。登录攻击者邮箱查看重置邮件：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima5.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">对比下客户端和接收端token：</span><br><span class="line">客户端：</span><br><span class="line">forgotPwdEa.php?isVerify&#x3D;eWFuZ3lhbmd3aXRoZ251fHlhbmd5YW5nd2l0aGdudUB5ZWFoLm5ldHw2MzQyNDkw&amp;PassPhrase&#x3D;01e4f6d4ede81b2604dc320bc4e3a6e8</span><br><span class="line">接收端：</span><br><span class="line">forgotPwdEc.php?isVerify&#x3D;eWFuZ3lhbmd3aXRoZ251fHlhbmd5YW5nd2l0aGdudUB5ZWFoLm5ldHw2MzQyNDkw&amp;PassPhrase&#x3D;01e4f6d4ede81b2604dc320bc4e3a6e8</span><br></pre></td></tr></table></figure>

<p>唯一不同点就是forgotPwdEa 和 forgotPwdEc 两个文件名。</p>
<p>接下来验证通过服务端泄漏的 token 能否重置普通用户的账号密码。从重置流程可知，要重置密码必须提供用户名及其邮箱（或手机号）。获取有效用户名。注册页面中，输入用户名后立即校验该用户名是否被占用：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima6.png" alt=""></p>
<p>对应请求、应答如下：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima7.png" alt=""></p>
<p>用户名已存在返回 failed，不存在返回 ok。以此特征，用常见国人姓名字典，可枚举出大量有效用户名（如 chenchuan、chenanqi、chenanxiu、zhangfeng 等等），存为 username.txt。</p>
<p>获取有效用户名对应邮箱。密码找回首页提交的请求中，user_name 与 email 参数匹配情况下，HTTP 应答代码为 302，交互包如下：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima8.png" alt=""></p>
<p>可以此特征枚举有效用户名及其邮箱。现在考虑如何制作邮箱字典？很多用户喜欢用用户名注册 qq 邮箱，换言之，用户名 yangyangwithgnu 可能对应邮箱 <a href="mailto:yangyangwithgnu@qq.com">yangyangwithgnu@qq.com</a>。所以，用前面已经获取有效用户名字典 username.txt 快速制作了邮箱字典 qq-email.txt，其中，username.txt 与 qq-email.txt 逐行对应。</p>
<p>例如，前者第一行为 yangyangwithgnu、后者第一行为 <a href="mailto:yangyangwithgnu@qq.com">yangyangwithgnu@qq.com</a>。将上面的数据包放入 burp 的 intrduer 中，攻击类型选 pitchfork、user_name 的参数值定义为枚举变量 1 并加载字典 username.txt、email 的参数值定义为枚举变量 2 并加载字典 qq-email.txt，可枚举出大量有效用户名/邮箱信息，如，zhangfeng/zhangfeng@qq.com、chenchuan/chenchuan@qq.com 等等。</p>
<p>用普通账号 chenchuan/chenchuan@qq.com 演示密码重置漏洞。输入用户名、密码提交，正常完成密码找回逻辑，从交互包中获取服务端下发的重置 token：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isVerify&#x3D;Y2hlbmNodWFufGNoZW5jaHVhbkBxcS5jb218MTE2MDIzNw&#x3D;&#x3D;&amp;PassPhrase&#x3D;cbf0160662358808f3586868f041cbaa</span><br></pre></td></tr></table></figure>

<p>拼装为重置链接 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.xxxx.com&#x2F;user&#x2F;forgotPwdEc.php?isVerify&#x3D;Y2hlbmNodWFufGNoZW5jaHVhbkBxcS5jb218MTE2MDIzNw&#x3D;&#x3D;&amp;PassPhrase&#x3D;cbf0160662358808f3586868f041cbaa</span><br></pre></td></tr></table></figure>

<p>访问之，即可进入密码重置页面，输入新密码 PenTest1024 后系统提示修改成功。用 chenchuan/PenTest1024 成功登录。</p>
<h3 id="防御-1"><a href="#防御-1" class="headerlink" title="防御"></a>防御</h3><p>密码找回的凭证切勿下发客户端，另外，校验邮箱是否有效应添加图片验证码，以防止关键参数被枚举。</p>
<h2 id="用户混淆"><a href="#用户混淆" class="headerlink" title="用户混淆"></a>用户混淆</h2><p>①<strong>通过 cookie 混淆不同账号，实现重置任意用户密码。</strong></p>
<p>码找回页面 ，用攻击者账号 yangyangwithgnu 走完密码找回全流程。</p>
<p>输入用户名和图片验证码后提交</p>
<p>验证为有效用户名后，系统提供手机、邮箱两种密码找回方式，选用邮箱方式：</p>
<p>登录邮箱查收重置验证码：</p>
<p>输入重置验证码：</p>
<p>进入新密码页面，输入后提交，拦截请求如下：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima17.png" alt=""></p>
<p>其中，PHPSESSID=dcusc1ahkn4ioqeeav9c6e0bdq、USER_ACCOUNT=yangyangwithgnu、 USER_APPID=1092 这三个参数引起我的注意。这个请求，用于重置账号 yangyangwithgnu 密码，那么服务端如何知道该重置 yangyangwithgnu 而不是 yangyangwithgnu2、yangyangwithgnu3 呢？刚才说的那三个参数中肯定有一个用于该目的。逐一尝试发现，PHPSESSID 就是它。</p>
<p>这让我闻到浓郁的 cookie 混淆的味道。大致攻击思路：首先，用攻击者账号 yangyangwithgnu 进入密码找回流程，查收重置验证码、通过校验；然后，输入新密码后提交，拦截中断该请求，暂不发至服务端，这时，PHPSESSID 关联的是 yangyangwithgnu 账号；接着，关闭浏览器的 burp 代理，新开重置流程的首页，在页面中输入普通账号 liuwei 后提交，这时，PHPSESSID 已关联成 liuwei 了；最后，恢复发送之前中断的请求，放至服务端，理论上，可以成功重置 liuwei 的密码。</p>
<p>用上述思路尝试将 liuwei 密码重置为 PenTest1024，前端显示重置成功.</p>
<p><strong>② 通过篡改请求包中的用户名参数，实现重置任意用户密码。</strong></p>
<p>密码找回页面 <a href="http://www.xxxx.cn/getpass.html，用攻击者账号走完密码找回全流程，涉及三步请求，依次为：验证用户名是否存在、获取短信验证码、提交短信验证码和新密码。第三步的请求拦截如下" target="_blank" rel="noopener">http://www.xxxx.cn/getpass.html，用攻击者账号走完密码找回全流程，涉及三步请求，依次为：验证用户名是否存在、获取短信验证码、提交短信验证码和新密码。第三步的请求拦截如下</a></p>
<p><img src="http://lulu.izliang.com/yty/renyimima18.png" alt=""></p>
<p>各参数作用从其命名可了解。尝试将 accountname 参数值篡改为普通账号 zhangzhiqiang 后放行，应答为：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima19.png" alt=""></p>
<p>重定向至登录页面。用普通账号 zhangzhiqiang/PenTest1024 登录成功。</p>
<p>另外，密码找回流程第三步的请求中的 vcode 参数为短信验证码，单次有效，不可复用，如何实现自动批量密码重置？经测试，将该参数置空，或者完整删除该参数，服务端不再校验短信验证码。</p>
<p>综上，几个问题结合，可导致任意用户密码重置。</p>
<p><strong>③通过篡改带 token 的重置链接中的用户名，实现重置任意用户密码。</strong></p>
<p><a href="http://xx.xxxx.com/echannel/forgetPassword/" target="_blank" rel="noopener">http://xx.xxxx.com/echannel/forgetPassword/</a> 为重置密码页面。攻击者用户 ID 为 42558。</p>
<p>输入攻击者账号绑定的邮箱后点击“确认”，收到如下带 token 的密码重置链接：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima20.png" alt=""></p>
<p>该重置链接有两个地方引起我的注意：一是，NDI1NTg= 为 base64 编码，解码为 42558，正是攻击者账号的用户 ID；二是，这是个 REST 风格的请求。所以，尝试用普通账号的用户 ID 的 base64 编码替换 NDI1NTg= 后，成功重置该普通用户的密码。</p>
<p><strong>特别注意</strong>：参数部份出现 / 应想到这是 rest 风格的参数和参数值。</p>
<h3 id="防御-2"><a href="#防御-2" class="headerlink" title="防御"></a>防御</h3><p>一定要将重置用户与接收重置凭证作一致性比较，通常直接从服务端直接生成，不从客户端获取。HTTP 参数污染、参数未提交等问题，服务端也要严格判断。</p>
<h2 id="重置凭证未校验"><a href="#重置凭证未校验" class="headerlink" title="重置凭证未校验"></a>重置凭证未校验</h2><p>服务端未校验重置凭证。换言之，不论你输入的重置验证码或密保答案是否正确，只要请求格式无误，均可成功重置任意账号密码。</p>
<p><strong>①因服务端未校验 token 导致可重置任意账号密码</strong></p>
<p>密码找回页面 <a href="http://www.omegatravel.net/users/retrievePassword/" target="_blank" rel="noopener">http://www.omegatravel.net/users/retrievePassword/</a> 用攻击者账号 <a href="mailto:yangyangwithgnu@yeah.net">yangyangwithgnu@yeah.net</a> 进入密码找回全流程，输入图片验证码后提交：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima21.png" alt=""></p>
<p>随后收到带 token 的密码重置链接的邮件：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima22.png" alt=""></p>
<p>其中，key:FqvICT 和 userEmail:<a href="mailto:yangyangwithgnu@yeah.net">yangyangwithgnu@yeah.net</a> 引起了我的注意。正常来说，提交该 URL 后，服务端会校验 key 与 userEmail 是否匹配，若匹配则进入提交新密码页面，若不匹配则报错。现在，我尝试将 key 从 FqvICT 改为 xxxxxx 后再访问，本来心理预期将看到报错页面，没想到进入了新密码提交页面</p>
<p>找个账号试试，就拿信息收集时找到的 <a href="mailto:travel24@omegatravel.net">travel24@omegatravel.net</a> 。参照前面收到的重置链接格式，简单拼装为 <a href="http://www.omegatravel.net/users/retrievePasswordReset/key:xxxxxx/userEmail:travel24@omegatravel.net，key" target="_blank" rel="noopener">http://www.omegatravel.net/users/retrievePasswordReset/key:xxxxxx/userEmail:travel24@omegatravel.net，key</a> 的值随便写的，访问看看，哇，居然真的进入了新密码提交页面.</p>
<p>输入新密码 PenTest1024 后提交，网站提示“修改密码成功”。尝试用 <a href="mailto:travel24@omegatravel.net">travel24@omegatravel.net</a>/PenTest1024 登录，成功进入系统。</p>
<p>如何获取其他账号？从注册页面可知，该网站只能用邮箱注册，邮箱即账号。我关心普通用户和内部员工用户两类账号（即邮箱）。普通用户的邮箱字典方面，把国人常见姓名拼音 top500 结合常见邮箱后缀（@qq.com、@163.com 等等）快速生成个简单邮箱字典；内部员工的邮箱方面，我从该网站域名注册信息查询到联系人为 <a href="mailto:omegait@omegauk.net">omegait@omegauk.net</a>，说明该公司使用 @omegauk.net 的邮箱后缀，同上，把国人常见姓名拼音 top500、常见后台账号，结合 @omegauk.net 邮箱后缀，快速生邮箱字典；另外，从“联系我们”、“诚聘英才”、“公司简介”等页面找到大量内部员工邮箱和合作伙伴邮箱，如 <a href="mailto:info@jadetravel.co.uk">info@jadetravel.co.uk</a>、info@ukchinese.com 等等，将以上几类邮箱字典存为 mail.txt 也就是用户名。这样，我不仅可以重置普通账号的密码，还能劫持大量内部员工、合作伙伴的账号。</p>
<p><strong>②可枚举无密保的用户名，导致任意密保答案均可重置密码</strong></p>
<p>在密码找回页面 <a href="http://www.hzpzs.net/u_findPassword.asp" target="_blank" rel="noopener">http://www.hzpzs.net/u_findPassword.asp</a> 输入有效用户名 yangyangwithgnu 后拦截请求包：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima23.png" alt=""></p>
<p>猜测该数据包用于用户名有效性校验，放至 repeater 中分析。</p>
<p>由于没用图片验证码，导致可枚举有效用户名，发现三类情况。</p>
<p>一是，用户名存在且设置过密保问题，应答类似：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima24.png" alt=""></p>
<p>二是，用户名存在但未设置密保问题，应答类似：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima25.png" alt=""></p>
<p>三是，无效用户名，则应答类似：</p>
<p><img src="http://lulu.izliang.com/yty/renyimima26.png" alt=""></p>
<p>用常见用户名和中国人姓名拼音作为字典进行枚举，在所有结果中过滤显示含有关键字 <code>&lt;td width=&quot;65%&quot;&gt;&lt;/td&gt;</code> 的应答，得到的所有 UserName 参数值即为未设置密保问题的用户名。如：aaron、admin、adolph、alisa、chenchen、esther、jones 等等。</p>
<p>按正常流程，对 chenxin 进行密码重置，输入任意密保答案均可重置密码.</p>
<h3 id="防御-3"><a href="#防御-3" class="headerlink" title="防御"></a>防御</h3><p>密码重置凭证一定要严格校验，空密保问题时禁止通过密保找回密码；服务端应限制枚举等恶意请求。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/" rel="tag"># 逻辑漏洞</a>
          
            <a href="/tags/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/" rel="tag"># 任意密码重置</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/05/ELK%E5%AD%A6%E4%B9%A0/" rel="next" title="ELK学习">
                <i class="fa fa-chevron-left"></i> ELK学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="prev" title="计算机网络">
                计算机网络 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1442298964,3218822834&fm=26&gp=0.jpg"
                alt="QuanYex" />
            
              <p class="site-author-name" itemprop="name">QuanYex</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#逻辑分析"><span class="nav-number">1.</span> <span class="nav-text">逻辑分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#重置姿势"><span class="nav-number">2.</span> <span class="nav-text">重置姿势</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#重置凭证接收端可篡改"><span class="nav-number">2.1.</span> <span class="nav-text">重置凭证接收端可篡改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#防御"><span class="nav-number">2.1.1.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重置凭证发送端可获取"><span class="nav-number">2.2.</span> <span class="nav-text">重置凭证发送端可获取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#防御-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户混淆"><span class="nav-number">2.3.</span> <span class="nav-text">用户混淆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#防御-2"><span class="nav-number">2.3.1.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重置凭证未校验"><span class="nav-number">2.4.</span> <span class="nav-text">重置凭证未校验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#防御-3"><span class="nav-number">2.4.1.</span> <span class="nav-text">防御</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QuanYex</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
